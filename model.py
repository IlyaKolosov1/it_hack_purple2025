import streamlit as st
from generate import generate_response

WELCOME_MESSAGE = """
### –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç-–ö–æ—Å–º–µ—Ç–æ–ª–æ–≥!
–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É—Ö–æ–¥—É –∑–∞ –∫–æ–∂–µ–π, –ø–æ–¥–±–æ—Ä—É –∫–æ—Å–º–µ—Ç–∏—á–µ—Å–∫–∏—Ö —Å—Ä–µ–¥—Å—Ç–≤ –∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—é —Ç–∏–ø–∞ –∫–æ–∂–∏.
"""

FIRST_MESSAGE = """
–Ø –ø–æ–º–æ–≥—É –≤–∞–º –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø –∫–æ–∂–∏, –≤—ã—è–≤–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã (—Å—É—Ö–æ—Å—Ç—å, –∂–∏—Ä–Ω–æ—Å—Ç—å, —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –∞–∫–Ω–µ) –∏ –ø–æ–¥–±–µ—Ä—É –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –∫–æ—Å–º–µ—Ç–∏—á–µ—Å–∫–∏–µ —Å—Ä–µ–¥—Å—Ç–≤–∞.  
**–î–ª—è –ª—É—á—à–µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —É–∫–∞–∂–∏—Ç–µ:**  
- –í–∞—à –≤–æ–∑—Ä–∞—Å—Ç  
- –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∫–æ–∂–∏ (–µ—Å–ª–∏ –∑–Ω–∞–µ—Ç–µ)  
- –û–±—Ä–∞–∑ –∂–∏–∑–Ω–∏ (—Å—Ç—Ä–µ—Å—Å, –ø–∏—Ç–∞–Ω–∏–µ, –≤—Ä–µ–¥–Ω—ã–µ –ø—Ä–∏–≤—ã—á–∫–∏)  
- –í–æ–∑–º–æ–∂–Ω—ã–µ –∞–ª–ª–µ—Ä–≥–∏–∏
"""

st.title("–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç-–∫–æ—Å–º–µ—Ç–æ–ª–æ–≥")
st.info(WELCOME_MESSAGE)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π –≤ session_state
if "messages" not in st.session_state:
    st.session_state.messages = [
        {
            'role': 'system',
            'content': (
                '–û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –¢—ã ‚Äì –æ–ø—ã—Ç–Ω—ã–π –∫–æ—Å–º–µ—Ç–æ–ª–æ–≥ —Å –º–Ω–æ–≥–æ–ª–µ—Ç–Ω–µ–π –ø—Ä–∞–∫—Ç–∏–∫–æ–π –≤ —É—Ö–æ–¥–µ –∑–∞ –∫–æ–∂–µ–π. '
                '–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äì –ø–æ–º–æ–≥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å –∏—Ö —Ç–∏–ø –∫–æ–∂–∏, –≤—ã—è–≤–ª—è—Ç—å –ø—Ä–æ–±–ª–µ–º—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å—É—Ö–æ—Å—Ç—å, –∂–∏—Ä–Ω–æ—Å—Ç—å, —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –∞–∫–Ω–µ) '
                '–∏ –¥–∞–≤–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É—Ö–æ–¥—É –∏ –≤—ã–±–æ—Ä—É –∫–æ—Å–º–µ—Ç–∏—á–µ—Å–∫–∏—Ö —Å—Ä–µ–¥—Å—Ç–≤. –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, —É—Ç–æ—á–Ω—è–π –¥–µ—Ç–∞–ª–∏ '
                '(–≤–æ–∑—Ä–∞—Å—Ç, –æ–±—Ä–∞–∑ –∂–∏–∑–Ω–∏, –Ω–∞–ª–∏—á–∏–µ –∞–ª–ª–µ—Ä–≥–∏–π). '
                '–¢—ã —Ç–∞–∫–∂–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–≤–µ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ —Å—Ü–µ–Ω–∞—Ä–∏—é ‚Äú—Å–±–æ—Ä–∞ –∫–æ—Ä–∑–∏–Ω—ã‚Äù, –æ–±—ä—è—Å–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–¥–±–æ—Ä–∞ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.'
                '—Ç–µ–±–µ –¥–∞—é—Ç –æ–ø–∏—Å–∞–Ω–∏–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (–æ–Ω–æ –ø–æ—Å—Ç—É–ø–∞–µ—Ç –æ—Ç –¥—Ä—É–≥–æ–π –Ω–µ–π—Ä–æ—Å–µ—Ç–∏, –Ω–µ –Ω—É–∂–Ω–æ –ø—Ä–æ –Ω–µ–µ —É–ø–æ–º–∏–Ω–∞—Ç—å –Ω–∏–∫–æ–≥–¥–∞), —Ç–≤–æ—è –∑–∞–¥–∞—á–∞ –ø–æ–¥—á–µ—Ä–∫–Ω—É—Ç—å –≤–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ –∏ –¥–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É—Ö–æ–¥—É –∑–∞ –∫–æ–∂–µ–π. –æ–±—ä—è—Å–Ω–∏—Ç—å —Å–≤–æ–π –≤—ã–±–æ—Ä'
            )
        },
        {
            'role': 'assistant',
            'content': FIRST_MESSAGE
        }
    ]

def main():
    # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞ –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ (–Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å–≤–µ—Ä—Ö—É)
    with st.container():
        for message in reversed(st.session_state.messages):
            role = message["role"]
            content = message["content"]
            if role == "user":
                # –ï—Å–ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —á–∞—Å—Ç—å –¥–æ –Ω–µ–≥–æ.
                if "–û–ø–∏—Å–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:" in content:
                    content = content.split("–û–ø–∏—Å–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:")[0].strip()
                st.markdown(f"**üë§ –í—ã:** {content}")
            elif role == "assistant":
                st.markdown(f"**üßë‚Äç‚öïÔ∏è –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç:**\n\n{content}")

    # –ü–æ–ª–µ –¥–ª—è –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
    user_input = st.text_area("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –∑–∞–ø—Ä–æ—Å:")
    
    # –í–∏–¥–∂–µ—Ç –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    uploaded_image = st.file_uploader("–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)", type=["jpg", "jpeg", "png"])
    
    if uploaded_image is not None:
        st.image(uploaded_image, caption="–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ", use_container_width=True)
    
    if st.button("–ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏"):
        if user_input.strip() or uploaded_image is not None:
            with st.spinner("–ú–æ–¥–µ–ª—å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å..."):
                image_bytes = uploaded_image.getvalue() if uploaded_image is not None else None
                response = generate_response(user_input, st.session_state.messages, image_bytes)
                st.markdown(f"**üßë‚Äç‚öïÔ∏è –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç:**\n\n{response}")
        else:
            st.warning("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.")

if __name__ == "__main__":
    main()
